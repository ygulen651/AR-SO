{"version":3,"file":"buildAction2.js","sources":["../../src/_internal/cli/actions/build/build.telemetry.ts","../../src/_internal/cli/actions/build/buildAction.ts"],"sourcesContent":["import {defineTrace} from '@sanity/telemetry'\n\nexport const BuildTrace = defineTrace<{outputSize: number}>({\n  name: 'Studio Build Completed',\n  version: 0,\n  description: 'A Studio build completed',\n})\n","import path from 'node:path'\n\nimport chalk from 'chalk'\nimport {info} from 'log-symbols'\nimport semver from 'semver'\nimport {noopLogger} from '@sanity/telemetry'\nimport {rimraf} from 'rimraf'\nimport type {CliCommandArguments, CliCommandContext} from '@sanity/cli'\n\nimport {buildStaticFiles} from '../../server'\nimport {checkStudioDependencyVersions} from '../../util/checkStudioDependencyVersions'\nimport {checkRequiredDependencies} from '../../util/checkRequiredDependencies'\nimport {getTimer} from '../../util/timing'\nimport {BuildTrace} from './build.telemetry'\nimport {buildVendorDependencies} from '../../server/buildVendorDependencies'\nimport {compareDependencyVersions} from '../../util/compareDependencyVersions'\nimport {getStudioAutoUpdateImportMap} from '../../util/getAutoUpdatesImportMap'\nimport {shouldAutoUpdate} from '../../util/shouldAutoUpdate'\nimport {formatModuleSizes, sortModulesBySize} from '../../util/moduleFormatUtils'\nimport {upgradePackages} from '../../util/packageManager/upgradePackages'\nimport {getPackageManagerChoice} from '../../util/packageManager/packageManagerChoice'\nimport {isInteractive} from '../../util/isInteractive'\n\nexport interface BuildSanityStudioCommandFlags {\n  'yes'?: boolean\n  'y'?: boolean\n  'minify'?: boolean\n  'stats'?: boolean\n  'source-maps'?: boolean\n  'auto-updates'?: boolean\n}\n\nexport default async function buildSanityStudio(\n  args: CliCommandArguments<BuildSanityStudioCommandFlags>,\n  context: CliCommandContext,\n  overrides?: {basePath?: string},\n): Promise<{didCompile: boolean}> {\n  const timer = getTimer()\n  const {output, prompt, workDir, cliConfig, telemetry = noopLogger} = context\n  const flags: BuildSanityStudioCommandFlags = {\n    'minify': true,\n    'stats': false,\n    'source-maps': false,\n    ...args.extOptions,\n  }\n\n  /**\n   * Unattended mode means that if there are any prompts it will use `YES` for them but will no change anything that doesn't have a prompt\n   */\n  const unattendedMode = Boolean(flags.yes || flags.y)\n  const defaultOutputDir = path.resolve(path.join(workDir, 'dist'))\n  const outputDir = path.resolve(args.argsWithoutOptions[0] || defaultOutputDir)\n\n  await checkStudioDependencyVersions(workDir)\n\n  // If the check resulted in a dependency install, the CLI command will be re-run,\n  // thus we want to exit early\n  const {didInstall, installedSanityVersion} = await checkRequiredDependencies(context)\n  if (didInstall) {\n    return {didCompile: false}\n  }\n\n  const autoUpdatesEnabled = shouldAutoUpdate({flags, cliConfig, output})\n\n  // Get the version without any tags if any\n  const coercedSanityVersion = semver.coerce(installedSanityVersion)?.version\n  if (autoUpdatesEnabled && !coercedSanityVersion) {\n    throw new Error(`Failed to parse installed Sanity version: ${installedSanityVersion}`)\n  }\n  const version = encodeURIComponent(`^${coercedSanityVersion}`)\n  const autoUpdatesImports = getStudioAutoUpdateImportMap(version)\n\n  if (autoUpdatesEnabled) {\n    output.print(`${info} Building with auto-updates enabled`)\n\n    // Check the versions\n    const result = await compareDependencyVersions(autoUpdatesImports, workDir)\n\n    if (result?.length) {\n      const warning =\n        `The following local package versions are different from the versions currently served at runtime.\\n` +\n        `When using auto updates, we recommend that you test locally with the same versions before deploying. \\n\\n` +\n        `${result.map((mod) => ` - ${mod.pkg} (local version: ${mod.installed}, runtime version: ${mod.remote})`).join('\\n')} \\n\\n`\n\n      // If it is non-interactive or in unattended mode, we don't want to prompt\n      if (isInteractive && !unattendedMode) {\n        const choice = await prompt.single({\n          type: 'list',\n          message: chalk.yellow(\n            `${warning}\\n\\nDo you want to upgrade local versions before deploying?`,\n          ),\n          choices: [\n            {\n              type: 'choice',\n              value: 'upgrade',\n              name: `Upgrade local versions (recommended). You will need to run the ${args.groupOrCommand} command again`,\n            },\n            {\n              type: 'choice',\n              value: 'upgrade-and-proceed',\n              name: `Upgrade and proceed with ${args.groupOrCommand}`,\n            },\n            {\n              type: 'choice',\n              value: 'continue',\n              name: `Continue anyway`,\n            },\n            {type: 'choice', name: 'Cancel', value: 'cancel'},\n          ],\n          default: 'upgrade-and-proceed',\n        })\n\n        if (choice === 'cancel') {\n          return {didCompile: false}\n        }\n\n        if (choice === 'upgrade' || choice === 'upgrade-and-proceed') {\n          await upgradePackages(\n            {\n              packageManager: (await getPackageManagerChoice(workDir, {interactive: false})).chosen,\n              packages: result.map((res) => [res.pkg, res.remote]),\n            },\n            context,\n          )\n\n          if (choice !== 'upgrade-and-proceed') {\n            return {didCompile: false}\n          }\n        }\n      } else {\n        // if non-interactive or unattended, just show the warning\n        console.warn(`WARNING: ${warning}`)\n      }\n    }\n  }\n\n  const envVarKeys = getSanityEnvVars()\n  if (envVarKeys.length > 0) {\n    output.print(\n      '\\nIncluding the following environment variables as part of the JavaScript bundle:',\n    )\n    envVarKeys.forEach((key) => output.print(`- ${key}`))\n    output.print('')\n  }\n\n  let shouldClean = true\n  if (outputDir !== defaultOutputDir && !unattendedMode) {\n    shouldClean = await prompt.single({\n      type: 'confirm',\n      message: `Do you want to delete the existing directory (${outputDir}) first?`,\n      default: true,\n    })\n  }\n\n  // Determine base path for built studio\n  let basePath = '/'\n  const envBasePath = process.env.SANITY_STUDIO_BASEPATH\n  const configBasePath = cliConfig?.project?.basePath\n\n  // Allow `sanity deploy` to override base path\n  if (overrides?.basePath) {\n    basePath = overrides.basePath\n  } else if (envBasePath) {\n    // Environment variable (SANITY_STUDIO_BASEPATH)\n    basePath = envBasePath\n  } else if (configBasePath) {\n    // `sanity.cli.ts`\n    basePath = configBasePath\n  }\n\n  if (envBasePath && configBasePath) {\n    output.warn(\n      `Overriding configured base path (${configBasePath}) with value from environment variable (${envBasePath})`,\n    )\n  }\n\n  let spin\n\n  if (shouldClean) {\n    timer.start('cleanOutputFolder')\n    spin = output.spinner('Clean output folder').start()\n    await rimraf(outputDir)\n    const cleanDuration = timer.end('cleanOutputFolder')\n    spin.text = `Clean output folder (${cleanDuration.toFixed()}ms)`\n    spin.succeed()\n  }\n\n  spin = output.spinner(`Build Sanity Studio`).start()\n\n  const trace = telemetry.trace(BuildTrace)\n  trace.start()\n\n  let importMap\n\n  if (autoUpdatesEnabled) {\n    importMap = {\n      imports: {\n        ...(await buildVendorDependencies({cwd: workDir, outputDir, basePath})),\n        ...autoUpdatesImports,\n      },\n    }\n  }\n\n  try {\n    timer.start('bundleStudio')\n\n    const bundle = await buildStaticFiles({\n      cwd: workDir,\n      outputDir,\n      basePath,\n      sourceMap: Boolean(flags['source-maps']),\n      minify: Boolean(flags.minify),\n      vite: cliConfig && 'vite' in cliConfig ? cliConfig.vite : undefined,\n      importMap,\n      reactCompiler:\n        cliConfig && 'reactCompiler' in cliConfig ? cliConfig.reactCompiler : undefined,\n      entry: cliConfig && 'app' in cliConfig ? cliConfig.app?.entry : undefined,\n    })\n\n    trace.log({\n      outputSize: bundle.chunks\n        .flatMap((chunk) => chunk.modules.flatMap((mod) => mod.renderedLength))\n        .reduce((sum, n) => sum + n, 0),\n    })\n    const buildDuration = timer.end('bundleStudio')\n\n    spin.text = `Build Sanity Studio (${buildDuration.toFixed()}ms)`\n    spin.succeed()\n\n    trace.complete()\n    if (flags.stats) {\n      output.print('\\nLargest module files:')\n      output.print(formatModuleSizes(sortModulesBySize(bundle.chunks).slice(0, 15)))\n    }\n  } catch (err) {\n    spin.fail()\n    trace.error(err)\n    throw err\n  }\n\n  return {didCompile: true}\n}\n\n// eslint-disable-next-line no-process-env\nfunction getSanityEnvVars(env: Record<string, string | undefined> = process.env): string[] {\n  return Object.keys(env).filter((key) => key.toUpperCase().startsWith('SANITY_STUDIO_'))\n}\n"],"names":["BuildTrace","defineTrace","name","version","description","buildSanityStudio","args","context","overrides","timer","getTimer","output","prompt","workDir","cliConfig","telemetry","noopLogger","flags","extOptions","unattendedMode","Boolean","yes","y","defaultOutputDir","path","resolve","join","outputDir","argsWithoutOptions","checkStudioDependencyVersions","didInstall","installedSanityVersion","checkRequiredDependencies","didCompile","autoUpdatesEnabled","shouldAutoUpdate","coercedSanityVersion","semver","coerce","Error","encodeURIComponent","autoUpdatesImports","getStudioAutoUpdateImportMap","print","info","result","compareDependencyVersions","length","warning","map","mod","pkg","installed","remote","isInteractive","choice","single","type","message","chalk","yellow","choices","value","groupOrCommand","default","upgradePackages","packageManager","getPackageManagerChoice","interactive","chosen","packages","res","warn","envVarKeys","getSanityEnvVars","forEach","key","shouldClean","basePath","envBasePath","process","env","SANITY_STUDIO_BASEPATH","configBasePath","project","spin","start","spinner","rimraf","cleanDuration","end","text","toFixed","succeed","trace","importMap","imports","buildVendorDependencies","cwd","bundle","buildStaticFiles","sourceMap","minify","vite","undefined","reactCompiler","entry","app","log","outputSize","chunks","flatMap","chunk","modules","renderedLength","reduce","sum","n","buildDuration","complete","stats","formatModuleSizes","sortModulesBySize","slice","err","fail","error","Object","keys","filter","toUpperCase","startsWith"],"mappings":"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"}